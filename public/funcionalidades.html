<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funcionalidades Adicionales</title>
    <link rel="stylesheet" href="styles-funcionalidades.css">
</head>
<body>
    <h1>Funcionalidades Adicionales</h1>
    <div class="container">
        <h2>Opciones</h2>
        <!-- Listar clientes por nombre y email -->
        <button onclick="listarClientes()">Listar Clientes (Nombre y Email)</button>
        <!-- Listar clientes mayores de 30 años -->
        <button onclick="listarMayores30()">Listar Clientes Mayores de 30 Años</button>
        <!-- Editar la ciudad de un cliente -->
        <form id="editar-ciudad-form">
            <h3>Editar Ciudad de un Cliente</h3>
            <input type="number" name="id" placeholder="ID del Cliente" required>
            <input type="text" name="ciudad" placeholder="Nueva Ciudad" required>
            <button type="submit">Actualizar Ciudad</button>
        </form>
        <!-- Editar la ciudad de todos los clientes en una ciudad específica -->
        <form id="editar-ciudad-todos-form">
            <h3>Editar Ciudad de Todos los Clientes</h3>
            <input type="text" name="ciudadActual" placeholder="Ciudad Actual" required>
            <input type="text" name="nuevaCiudad" placeholder="Nueva Ciudad" required>
            <button type="submit">Actualizar Todas las Ciudades</button>
        </form>
        <!-- Eliminar un cliente por su nombre -->
        <form id="eliminar-por-nombre-form">
            <h3>Eliminar Cliente por Nombre</h3>
            <input type="text" name="nombre" placeholder="Nombre del Cliente" required>
            <button type="submit">Eliminar Cliente</button>
        </form>
        <!-- Eliminar todos los clientes que pertenezcan a una misma ciudad -->
        <form id="eliminar-por-ciudad-form">
            <h3>Eliminar Clientes por Ciudad</h3>
            <input type="text" name="ciudad" placeholder="Ciudad" required>
            <button type="submit">Eliminar Clientes</button>
        </form>
    </div>
    <button onclick="window.location.href='/clientes.html'">Volver al CRUD de Clientes</button>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h2>Resultado</h2>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // Función para abrir el modal
        function abrirModal(contenido) {
            const modal = document.getElementById('modal');
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = contenido;
            modal.style.display = 'block';
        }

        // Función para cerrar el modal
        function cerrarModal() {
            const modal = document.getElementById('modal');
            modal.style.display = 'none';
        }

        // Función para listar clientes por nombre y email
        function listarClientes() {
            fetch('/clientes/listar')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const contenido = `
                            <h3>Clientes:</h3>
                            <ul>
                                ${data.map(cliente => `<li>${cliente.nombre} - ${cliente.email}</li>`).join('')}
                            </ul>
                        `;
                        abrirModal(contenido);
                    } else {
                        abrirModal('<p>No se encontraron clientes.</p>');
                    }
                })
                .catch(err => {
                    console.error('Error al listar clientes:', err);
                    abrirModal('<p>Error al obtener los clientes.</p>');
                });
        }

        // Función para listar clientes mayores de 30 años
        function listarMayores30() {
            fetch('/clientes/mayores30')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const contenido = `
                            <h3>Clientes mayores de 30 años:</h3>
                            <ul>
                                ${data.map(cliente => `<li>${cliente.nombre} - ${cliente.email}</li>`).join('')}
                            </ul>
                        `;
                        abrirModal(contenido);
                    } else {
                        abrirModal('<p>No se encontraron clientes mayores de 30 años.</p>');
                    }
                })
                .catch(err => {
                    console.error('Error al listar clientes mayores de 30 años:', err);
                    abrirModal('<p>Error al obtener los clientes mayores de 30 años.</p>');
                });
        }

        // Función para editar la ciudad de un cliente y mostrar el antes y después
        document.getElementById('editar-ciudad-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.id.value;
            const ciudad = this.ciudad.value;

            // Obtener los datos actuales del cliente antes de realizar el cambio
            fetch(`/clientes/${id}`)
                .then(response => response.json())
                .then(clienteAntes => {
                    fetch(`/clientes/editar-ciudad/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ciudad })
                    })
                        .then(response => response.json())
                        .then(data => {
                            const contenido = `
                                <h3>Cliente afectado:</h3>
                                <p><strong>Antes:</strong> ${clienteAntes.nombre} - Ciudad: ${clienteAntes.ciudad}</p>
                                <p><strong>Después:</strong> ${clienteAntes.nombre} - Ciudad: ${ciudad}</p>
                                <p>${data.message}</p>
                            `;
                            abrirModal(contenido);
                        })
                        .catch(err => console.error('Error al actualizar la ciudad del cliente:', err));
                })
                .catch(err => console.error('Error al obtener cliente antes del cambio:', err));
        });

        // Función para editar la ciudad de todos los clientes en una ciudad específica
        document.getElementById('editar-ciudad-todos-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const ciudadActual = this.ciudadActual.value;
            const nuevaCiudad = this.nuevaCiudad.value;

            fetch('/clientes/editar-ciudad-todos', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ciudadActual, nuevaCiudad })
            })
                .then(response => response.json())
                .then(data => {
                    const contenido = `
                        <h3>Clientes afectados:</h3>
                        <p><strong>Ciudad Actual:</strong> ${ciudadActual}</p>
                        <p><strong>Nueva Ciudad:</strong> ${nuevaCiudad}</p>
                        <p>${data.message}</p>
                    `;
                    abrirModal(contenido);
                })
                .catch(err => console.error('Error al actualizar ciudades:', err));
        });

        document.getElementById('eliminar-por-nombre-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const nombre = this.nombre.value;
            fetch('/clientes/eliminar-por-nombre', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre })
            })
                .then(response => response.json())
                .then(data => {
                    const contenido = `
                        <h3>Cliente eliminado:</h3>
                        <p><strong>Nombre:</strong> ${nombre}</p>
                        <p>${data.message}</p>
                    `;
                    abrirModal(contenido);
                })
                .catch(err => console.error('Error al eliminar cliente por nombre:', err));
        });

        document.getElementById('eliminar-por-ciudad-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const ciudad = this.ciudad.value;
            fetch('/clientes/eliminar-por-ciudad', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ciudad })
            })
                .then(response => response.json())
                .then(data => {
                    const contenido = `
                        <h3>Clientes eliminados:</h3>
                        <p><strong>Ciudad:</strong> ${ciudad}</p>
                        <p>${data.message}</p>
                    `;
                    abrirModal(contenido);
                })
                .catch(err => console.error('Error al eliminar clientes por ciudad:', err));
        });
    </script>
</body>
</html>
